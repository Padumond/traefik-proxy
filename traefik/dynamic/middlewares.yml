# Dynamic Configuration - Middlewares
# These can be reused across multiple services

http:
  middlewares:
    # ===========================================
    # SECURITY HEADERS (Production-Ready)
    # ===========================================
    secure-headers:
      headers:
        # Prevent clickjacking
        frameDeny: true
        customFrameOptionsValue: "SAMEORIGIN"

        # XSS Protection
        browserXssFilter: true
        contentTypeNosniff: true

        # HSTS - Force HTTPS
        stsIncludeSubdomains: true
        stsPreload: true
        stsSeconds: 31536000
        forceSTSHeader: true

        # Content Security Policy
        contentSecurityPolicy: |
          default-src 'self';
          script-src 'self' 'unsafe-inline' 'unsafe-eval';
          style-src 'self' 'unsafe-inline';
          img-src 'self' data: https:;
          font-src 'self' data:;
          connect-src 'self' https:;
          frame-ancestors 'self';
          base-uri 'self';
          form-action 'self'

        # Referrer Policy
        referrerPolicy: "strict-origin-when-cross-origin"

        # Permissions Policy (formerly Feature-Policy)
        permissionsPolicy: "camera=(), microphone=(), geolocation=(), payment=()"

        # Custom security headers
        customResponseHeaders:
          X-Robots-Tag: "noindex, nofollow, nosnippet, noarchive"
          X-Download-Options: "noopen"
          X-Permitted-Cross-Domain-Policies: "none"

    # ===========================================
    # RATE LIMITING
    # ===========================================

    # Standard rate limit for most services
    rate-limit:
      rateLimit:
        average: 100
        burst: 50
        period: 1s

    # Strict rate limit for login/auth endpoints
    rate-limit-auth:
      rateLimit:
        average: 10
        burst: 5
        period: 1m

    # API rate limit (higher for API consumers)
    rate-limit-api:
      rateLimit:
        average: 200
        burst: 100
        period: 1s

    # ===========================================
    # CORS MIDDLEWARE FOR APIs
    # ===========================================

    # Permissive CORS (development)
    cors-permissive:
      headers:
        accessControlAllowMethods:
          - GET
          - POST
          - PUT
          - PATCH
          - DELETE
          - OPTIONS
        accessControlAllowHeaders:
          - Content-Type
          - Authorization
          - X-Requested-With
        accessControlAllowOriginList:
          - "*"
        accessControlMaxAge: 100
        addVaryHeader: true

    # Restrictive CORS (production - specify your domains)
    cors-headers:
      headers:
        accessControlAllowMethods:
          - GET
          - POST
          - PUT
          - PATCH
          - DELETE
          - OPTIONS
        accessControlAllowHeaders:
          - Content-Type
          - Authorization
          - X-Requested-With
          - Accept
          - Origin
          - X-API-Key
        accessControlAllowOriginList:
          # MAS3NDI domains
          - "https://mas3ndi.com"
          - "https://www.mas3ndi.com"
        accessControlAllowCredentials: true
        accessControlMaxAge: 7200
        addVaryHeader: true

    # ===========================================
    # COMPRESSION
    # ===========================================
    compress:
      compress:
        excludedContentTypes:
          - "text/event-stream"

    # ===========================================
    # PATH MANIPULATION
    # ===========================================

    # Strip /api prefix
    strip-api-prefix:
      stripPrefix:
        prefixes:
          - "/api"

    # Add trailing slash
    add-trailing-slash:
      redirectRegex:
        regex: "^(https?://[^/]+/[^?]+[^/?])$"
        replacement: "${1}/"
        permanent: true

    # ===========================================
    # RETRY & CIRCUIT BREAKER
    # ===========================================

    # Retry failed requests
    retry:
      retry:
        attempts: 3
        initialInterval: 100ms

    # Circuit breaker for failing services
    circuit-breaker:
      circuitBreaker:
        expression: "NetworkErrorRatio() > 0.30 || ResponseCodeRatio(500, 600, 0, 600) > 0.25"

    # ===========================================
    # REQUEST BUFFERING
    # ===========================================

    # Buffer large requests (file uploads)
    buffering:
      buffering:
        maxRequestBodyBytes: 10485760 # 10MB
        memRequestBodyBytes: 2097152 # 2MB
        maxResponseBodyBytes: 10485760
        memResponseBodyBytes: 2097152
        retryExpression: "IsNetworkError() && Attempts() < 2"
